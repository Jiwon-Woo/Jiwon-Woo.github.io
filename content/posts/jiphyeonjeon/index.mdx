---
title: 웹 서비스의 도서 검색 경험 개선기
date: 2023-10-06
tags:
  - 검색 고도화
  - MySQL full-text search
---

![success](./1.png)

## 0️⃣ **개요**

- 도서관 동아리 ‘집현전’ / Backend
- 프로젝트 기간: 2023.08 -2023.09 (1개월)
- 프로젝트 구성원: Backend(3), Frontend(1)
- 홈페이지: [https://42library.kr](https://42library.kr/)
- GitHub: [https://github.com/orgs/jiphyeonjeon-42/projects/10](https://github.com/orgs/jiphyeonjeon-42/projects/10)

### **도서 관리 웹 서비스 소개**

42서울의 도서관 ’집현전’에서 출시한 웹서비스입니다. 모든 사용자는 집현전에 있는 1,400권 정도의 도서를 검색할 수 있고, 42 인증이 된 사용자만 도서 예약이 가능합니다. 추가로 집현전의 사서들은 웹사이트를 통해 도서 대출/반납 업무를 할 수 있고, 도서 관리 또한 가능합니다. 2023년 8월 기준 대략 600명의 가입자, 1,700건의 대출, 100건의 예약 기록이 누적되었습니다. 집현전 웹사이트는 2022년 하반기 구글 애널리틱스 1,500뷰, 2023년 상반기 2,200뷰를 달성하며 성장하고 있습니다.

### **도서 관리 웹 서비스 DB 구조**

![DB](https://github.com/jiphyeonjeon-42/discussion/assets/74581396/ae219dd8-9603-4fff-9324-6529877fc1f2)

| 테이블 | 설명 | 비고 |
| --- | --- | --- |
| user | 사용자 관련 정보 |  |
| category | 도서 카테고리 |  |
| book_info | 제목, 저자 등의 도서 고유 정보 (단위: 종) |  |
| book | 특정한 도서 한 권의 정보 (단위: 권) |  |
| reservation | 도서 예약 정보 |  |
| lending | 도서 대출 정보 |  |
| likes | 도서 별 “좋아요” 정보 |  |
| reviews | 도서에 등록된 리뷰 정보 |  |
| super_tag | 도서의 상위 태그 |  |
| sub_tag | 도서의 하위 태그 |  |
| book_info_search_keywords | book_info를 검색하기 위한 검색어 정보 | 신규 |
| search_keywords | 검색어 정보, 한 번도 검색된 적 없는 키워드를 검색할 때 저장 | 신규 |
| search_logs | 검색어 로그, 검색할 때마다 search_keyword_id를 함께 저장 | 신규 |

<br />

## **1️⃣ 검색 기능 개선**

### **기존 검색 기능의 한계**

기존 검색 기능에는 아래와 같은 한계점이 있었습니다.

1. 검색어에 띄어쓰기를 포함한 결과와 불포함한 결과가 매우 상이

	<img src="https://github.com/jiphyeonjeon-42/discussion/assets/74581396/5791e5f0-6931-49e3-a768-b12cb5ffb7b6" width="49%" height="49%" />
	<img src="https://github.com/jiphyeonjeon-42/discussion/assets/74581396/1373135f-fd7a-49bb-b8f6-8dfea5b511e1" width="49%" height="49%" />

2. 도서명, 저자, 출판사 복합 검색 불가능

	<img src="https://github.com/jiphyeonjeon-42/discussion/assets/74581396/184728d3-0ba3-4d06-9773-179dec2f12ea" width="49%" height="49%" />

3. 자모 분리 검색 불가능 (예. ‘파있’과 ‘파이썬’ 검색 결과가 매우 상이)

	<img src="https://github.com/jiphyeonjeon-42/discussion/assets/74581396/74583716-3462-43ef-9819-b70d8554b468" width="49%" height="49%" />
	<img src="https://github.com/jiphyeonjeon-42/discussion/assets/74581396/ddf0bf3e-0e27-4b28-a983-0cfeca4dd96c" width="49%" height="49%" />


이러한 한계를 개선하기 위해 해당 프로젝트에서 유연한 검색을 가능하게 하고, 몇 가지 검색 편의 기능을 도입하여 원하는 자료를 찾는데 소요되는 단계를 단축했습니다.

### **기술적 고민 및 구현 방법**

먼저 검색 기능 강화를 위해 Elasticsearch, MySQL 전문 검색, LIKE 연산자를 비교하며 어떤 것을 사용해야 할지 고민했습니다. Elasticsearch는 대표적인 검색 엔진인 만큼 검색 기능이 강력하고, 한글 형태소 분석까지 지원하지만, 기존에 운영하고 있던 MySQL DB와 같이 운영할 때 생기는 단점이 있었습니다. 도서 정보 테이블과 도서 정보 검색을 위한 정보를 따로 사용하게 되면 단일 DB만 사용할 때보다 데이터 일관성이 떨어질 위험이 커지고, 한 번의 요청으로 처리될 수 있었던 기능도 복수의 요청을 보내야 합니다. 프로젝트나 데이터의 규모도 크지 않기 때문에 기존에 사용하던 MySQL을 최대한 활용해서 기능을 구현하기로 했습니다.

LIKE로는 한 항목에서만 단순 부분 일치를 판단하여 결과를 반환합니다. 반면 MySQL 전문 검색은 공백을 기준으로 토큰화하여 여러 항목에서 복합 검색이 가능합니다. 예를 들어 ‘김영한 자바’라고 검색하면 저자에 ‘김영한’, 책 제목에 ‘자바’가 포함된 검색 결과를 얻을 수 있습니다. 하지만 MySQL 전문 검색 결과가 LIKE를 검색 결과를 전부 포함할 것이라는 예상과 달리 두 결과에는 각각 여집합 부분이 존재했습니다. 두 검색 결과가 상호보완적이고, 전문 검색만 사용한 응답 속도와 전문 검색과 LIKE를 같이 사용한 응답 속도에 큰 차이가 없었기 때문에 MySQL 전문 검색과 LIKE 검색 결과물을 함께 제공하게 되었습니다.

자음과 모음을 분리한 검색, 그리고 좀 더 나아가 초성 검색까지 구현하기로 했습니다. hangul-js 라이브러리를 채택하여 도서 정보의 일부(도서명, 저자, 출판사)를 자음과 모음으로 분해하는 작업과 초성만 추출하는 작업을 수행하고, 테이블에 저장해 두었습니다. 그리고 자음과 모음이 분리된 칼럼들과 초성 칼럼들을 각각 n-gram 파서를 사용하는 전문 인덱스로 구성했습니다. 인덱스를 도서명, 저자, 출판사로 구성했기 때문에 복합 검색이 가능해졌고, 사용자가 입력한 검색어 또한 hangul-js를 통해 분리함으로써 자모 분리 검색과 초성 검색을 구현할 수 있었습니다. 그리고 각 칼럼을 LIKE로 검색할 경우에는 검색어의 공백을 와일드카드 ‘%’로 치환하여 띄어쓰기 여부에 따른 검색 결과의 차이를 줄였습니다.


### **검색 기능 개선 이후**

1. ‘자바스크립트’와 ‘자바 스크립트’의 결과의 교집합이 생기며, ‘자바 스크립트’의 경우 전문 검색에 의해 ‘자바’나 ‘스크립트’ 둘 중 하나만 포함해도 검색 결과에 반환됨

	<img src="https://github.com/jiphyeonjeon-42/discussion/assets/74581396/9a0a99e3-c7e2-4305-99ac-088857c90941" width="49%" height="49%" />
	<img src="https://github.com/jiphyeonjeon-42/discussion/assets/74581396/4d45e8b3-1a9d-4965-b594-30bb78ca11e9" width="49%" height="49%" />

2. 도서명, 저자 복합 검색 가능

	<img src="https://github.com/jiphyeonjeon-42/discussion/assets/74581396/cf886c9a-5010-4a27-a52a-d256c2986961" width="49%" height="49%" />

3. ‘파있’과 ‘ㅍㅇㅆ’ 검색 시 ‘파이썬’ 검색 결과와 유사

	<img src="https://github.com/jiphyeonjeon-42/discussion/assets/74581396/b5ca4da3-2040-48f6-b331-5ac55a30fb1f" width="49%" height="49%" />
	<img src="https://github.com/jiphyeonjeon-42/discussion/assets/74581396/d4c60714-2dbb-4f24-a57c-6e384282c7fa" width="49%" height="49%" />


<br />

## **2️⃣ 인기 검색어 구현**

### **검색 편의 기능의 부재**

기존 서비스에서는 기본 검색 기능을 제외하고, 타 사이트에서 자주 볼 수 있는 자동완성, 검색 결과 미리보기, 최근 검색어, 인기 검색어 등의 검색 편의 기능이 없었습니다. 그래서 사용자의 검색 경험을 개선하고, 다른 사용자의 검색어를 공개하여 검색 유도를 하기 위한 목적으로 인기 검색어를 도입하게 되었습니다.

### **기술적 고민 및 구현 방법**

인기 검색어 기능을 오픈하자마자 인기 검색어 순위를 제공하고 싶었기 때문에 이전에 쌓인 로그를 활용했습니다. 7~8월 중 보름간 들어온 도서 검색 Request를 파싱하여 검색어와 검색 로그 테이블에 저장했습니다.

좀 더 다양한 볼거리를 위해 인기 검색어 순위뿐만 아니라 해당 인기 검색어의 순위 변동을 구현하기로 했습니다. 순위 변동 구현을 위해서는 어느 지점을 이전 인기 검색어로 생각할지, 이전 인기 검색어를 어떻게 저장할지에 대해 고민했습니다. 이미 기존에 node-schedule 라이브러리를 이용하여 스케줄러를 구성하고 있었기 때문에, 해당 스케줄러를 활용하여 0시 42분마다 하루 전 인기 검색어를 집계하고, 이를 순위 변동의 기준으로 사용했습니다. 순위 변동의 기준은 가장 최근 것 하나만 필요하고 운영 서버를 한 대만 이용하고 있기 때문에 애플리케이션 단에 캐싱해 두었습니다.

검색량이 풍부하지 않기 때문에 인기 검색어를 어떤 방식으로 10개를 채울지 기준을 세웠습니다. 먼저 인기 검색어를 요청한 시점부터 24시간 이내에 N회 이상 발생한 검색어를 추출합니다. 만약 추출된 검색어의 개수가 10개 미만이면 요청 시점으로부터 한 달 이내 N회 이상 발생한 검색어를 한 번 더 추출하여 채워 넣습니다. 그래도 부족하다면 전 기간에 걸쳐 N회 이상 발생한 검색어를 추가로 추출하도록 했습니다.


### **인기 검색어 화면**

![인기1](https://github.com/jiphyeonjeon-42/discussion/assets/74581396/4b1ac1e0-2598-43c8-b570-2adf36ad4063)
![인기2](https://github.com/jiphyeonjeon-42/discussion/assets/74581396/fcff1ea2-c564-485e-8235-a84fbf117235)